# Database schema (public)

Generated by db snapshot workflow.

## Tablas
### app_allowed_users
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `email` | `text` | No |  |
| `role` | `text` | No | `'staff'::text` |
| `is_active` | `boolean` | No | `true` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `can_reservas` | `boolean` | No | `true` |
| `can_mantenimiento` | `boolean` | No | `true` |
| `can_cocina` | `boolean` | No | `true` |
| `display_name` | `text` | Sí |  |
| `can_cheffing` | `boolean` | No | `false` |
| `cheffing_images_manage` | `boolean` | No | `false` |

### cheffing_dish_items
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `dish_id` | `uuid` | No |  |
| `ingredient_id` | `uuid` | Sí |  |
| `subrecipe_id` | `uuid` | Sí |  |
| `unit_code` | `text` | No |  |
| `quantity` | `numeric` | No |  |
| `notes` | `text` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |
| `waste_pct_override` | `numeric` | Sí |  |

### cheffing_dishes
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `selling_price` | `numeric` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |
| `servings` | `integer` | No | `1` |
| `units_sold` | `integer` | No | `0` |

### cheffing_ingredients
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `purchase_unit_code` | `text` | No |  |
| `purchase_pack_qty` | `numeric` | No |  |
| `purchase_price` | `numeric` | No |  |
| `waste_pct` | `numeric` | No | `0` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |
| `categories` | `text[]` | No | `'{}'::text[]` |
| `reference` | `text` | Sí |  |
| `stock_unit_code` | `text` | Sí |  |
| `stock_qty` | `numeric` | No | `0` |
| `min_stock_qty` | `numeric` | Sí |  |
| `max_stock_qty` | `numeric` | Sí |  |
| `allergen_codes` | `text[]` | No | `'{}'::text[]` |
| `indicator_codes` | `text[]` | No | `'{}'::text[]` |

### cheffing_pos_product_links
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `pos_product_id` | `text` | No |  |
| `dish_id` | `uuid` | No |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### cheffing_pos_sales_daily
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `sale_day` | `date` | No |  |
| `outlet_id` | `text` | No | `'default'::text` |
| `pos_product_id` | `text` | No |  |
| `pos_product_name` | `text` | Sí |  |
| `units` | `numeric` | No | `0` |
| `revenue` | `numeric` | Sí |  |
| `currency` | `text` | No | `'EUR'::text` |
| `source` | `text` | No | `'pos'::text` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### cheffing_subrecipe_items
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `subrecipe_id` | `uuid` | No |  |
| `ingredient_id` | `uuid` | Sí |  |
| `subrecipe_component_id` | `uuid` | Sí |  |
| `unit_code` | `text` | No |  |
| `quantity` | `numeric` | No |  |
| `notes` | `text` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### cheffing_subrecipes
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `output_unit_code` | `text` | No |  |
| `output_qty` | `numeric` | No |  |
| `waste_pct` | `numeric` | No | `0` |
| `notes` | `text` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### cheffing_units
RLS: habilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `code` | `text` | No |  |
| `name` | `text` | Sí |  |
| `dimension` | `text` | No |  |
| `to_base_factor` | `numeric` | No |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### day_status
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `event_date` | `date` | No |  |
| `validated_by` | `text` | Sí |  |
| `validated_at` | `timestamp with time zone` | No | `now()` |
| `day_notes` | `text` | Sí |  |
| `is_validated` | `boolean` | No | `false` |
| `events_last_reviewed_at` | `timestamp with time zone` | Sí |  |
| `cocina_notes` | `text` | Sí |  |
| `mantenimiento_notes` | `text` | Sí |  |
| `last_validated_at` | `timestamp with time zone` | Sí | `now()` |
| `last_validated_by` | `text` | Sí |  |
| `notes_general` | `text` | Sí |  |
| `notes_kitchen` | `text` | Sí |  |
| `notes_maintenance` | `text` | Sí |  |
| `validated` | `boolean` | No | `false` |
| `last_edited_at` | `timestamp with time zone` | Sí | `now()` |

### group_events
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `event_date` | `date` | No |  |
| `entry_time` | `time without time zone` | No |  |
| `has_private_dining_room` | `boolean` | No | `false` |
| `has_private_party` | `boolean` | No | `false` |
| `adults` | `integer` | No | `0` |
| `children` | `integer` | No | `0` |
| `total_pax` | `integer` | Sí | `(adults + children)` |
| `seconds_confirmed` | `boolean` | No | `false` |
| `second_course_type` | `text` | Sí |  |
| `menu_text` | `text` | Sí |  |
| `allergens_and_diets` | `text` | Sí |  |
| `extras` | `text` | Sí |  |
| `setup_notes` | `text` | Sí |  |
| `deposit_amount` | `numeric(10,2)` | Sí |  |
| `deposit_status` | `text` | Sí |  |
| `invoice_data` | `text` | Sí |  |
| `status` | `text` | No | `'confirmed'::text` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |
| `calendar_event_id` | `text` | Sí |  |
| `calendar_deleted_externally` | `boolean` | No | `false` |
| `service_outcome` | `group_service_outcome` | No | `'normal'::group_service_outcome` |
| `service_outcome_notes` | `text` | Sí |  |
| `menu_id` | `uuid` | Sí |  |

### group_room_allocations
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `group_event_id` | `uuid` | No |  |
| `room_id` | `uuid` | No |  |
| `adults` | `integer` | No | `0` |
| `children` | `integer` | No | `0` |
| `total_pax` | `integer` | Sí | `(adults + children)` |
| `override_capacity` | `boolean` | No | `false` |
| `notes` | `text` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### group_staffing_plans
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `group_event_id` | `uuid` | No |  |
| `staffing_ratio_id` | `uuid` | No |  |
| `total_pax` | `integer` | No |  |
| `recommended_waiters` | `integer` | No | `0` |
| `recommended_runners` | `integer` | No | `0` |
| `recommended_bartenders` | `integer` | No | `0` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### menu_second_courses
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `menu_id` | `uuid` | No |  |
| `code` | `text` | No |  |
| `name` | `text` | No |  |
| `description_kitchen` | `text` | No |  |
| `needs_doneness_points` | `boolean` | No | `false` |
| `sort_order` | `integer` | No | `0` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### menus
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `code` | `text` | No |  |
| `display_name` | `text` | No |  |
| `price_eur` | `numeric(10,2)` | No |  |
| `starters_text` | `text` | Sí |  |
| `dessert_text` | `text` | Sí |  |
| `drinks_text` | `text` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### rooms
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `capacity_seated` | `integer` | No | `0` |
| `capacity_standing` | `integer` | Sí | `0` |
| `sort_order` | `integer` | No | `0` |
| `is_active` | `boolean` | No | `true` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### routine_packs
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `description` | `text` | Sí |  |
| `area` | `task_area` | Sí |  |
| `enabled` | `boolean` | No | `false` |
| `auto_generate` | `boolean` | No | `false` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### routines
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `area` | `task_area` | No |  |
| `title` | `text` | No |  |
| `description` | `text` | Sí |  |
| `day_of_week` | `integer` | No |  |
| `priority` | `task_priority` | No | `'normal'::task_priority` |
| `is_active` | `boolean` | No | `true` |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |
| `start_day_of_week` | `integer` | No | `1` |
| `end_day_of_week` | `integer` | No | `7` |
| `routine_pack_id` | `uuid` | Sí |  |

### staffing_ratios
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `name` | `text` | No |  |
| `waiter_per_pax` | `integer` | No |  |
| `runner_per_pax` | `integer` | No |  |
| `min_bartenders` | `integer` | No | `1` |
| `private_party_extra_bartender_per_pax` | `integer` | No |  |
| `is_active` | `boolean` | No | `true` |
| `valid_from` | `date` | Sí |  |
| `valid_to` | `date` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |

### tasks
RLS: deshabilitado

| Columna | Tipo | Nullable | Default |
| --- | --- | --- | --- |
| `id` | `uuid` | No | `gen_random_uuid()` |
| `area` | `task_area` | No |  |
| `title` | `text` | No |  |
| `description` | `text` | Sí |  |
| `status` | `task_status` | No | `'open'::task_status` |
| `priority` | `task_priority` | No | `'normal'::task_priority` |
| `due_date` | `date` | Sí |  |
| `created_by_email` | `text` | Sí |  |
| `created_at` | `timestamp with time zone` | No | `now()` |
| `updated_at` | `timestamp with time zone` | No | `now()` |
| `routine_id` | `uuid` | Sí |  |
| `routine_week_start` | `date` | Sí |  |
| `window_start_date` | `date` | Sí |  |


## ENUMs
- `group_service_outcome`: `normal`, `annotation`, `incident`, `no_show`, `note`
- `task_area`: `maintenance`, `kitchen`
- `task_priority`: `low`, `normal`, `high`
- `task_status`: `open`, `in_progress`, `done`

## Views
- `v_cheffing_dish_cost`
- `v_cheffing_dish_items_cost`
- `v_cheffing_ingredients_cost`
- `v_cheffing_menu_engineering_dish_cost`
- `v_cheffing_subrecipe_cost`
- `v_daily_room_occupancy`
- `v_daily_staffing_summary`
- `v_day_status`
- `v_group_events_calendar_sync`
- `v_group_events_daily_detail`
- `v_maintenance_daily_detail`

## RLS & Policies
| Tabla | Política | Comando | Roles | USING | WITH CHECK |
| --- | --- | --- | --- | --- | --- |
| `app_allowed_users` | `read own allowlist row` | SELECT | authenticated | `((is_active = true) AND (lower(email) = lower(COALESCE((auth.jwt() ->> 'email'::text), current_setting('request.jwt.claim.email'::text, true)))))` | `` |
| `cheffing_dish_items` | `cheffing_dish_items_delete` | DELETE | public | `cheffing_is_allowed()` | `` |
| `cheffing_dish_items` | `cheffing_dish_items_insert` | INSERT | public | `` | `cheffing_is_allowed()` |
| `cheffing_dish_items` | `cheffing_dish_items_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_dish_items` | `cheffing_dish_items_update` | UPDATE | public | `cheffing_is_allowed()` | `cheffing_is_allowed()` |
| `cheffing_dishes` | `cheffing_dishes_delete` | DELETE | public | `cheffing_is_allowed()` | `` |
| `cheffing_dishes` | `cheffing_dishes_insert` | INSERT | public | `` | `cheffing_is_allowed()` |
| `cheffing_dishes` | `cheffing_dishes_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_dishes` | `cheffing_dishes_update` | UPDATE | public | `cheffing_is_allowed()` | `cheffing_is_allowed()` |
| `cheffing_ingredients` | `cheffing_ingredients_delete` | DELETE | public | `cheffing_is_allowed()` | `` |
| `cheffing_ingredients` | `cheffing_ingredients_insert` | INSERT | public | `` | `cheffing_is_allowed()` |
| `cheffing_ingredients` | `cheffing_ingredients_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_ingredients` | `cheffing_ingredients_update` | UPDATE | public | `cheffing_is_allowed()` | `cheffing_is_allowed()` |
| `cheffing_pos_product_links` | `cheffing_pos_product_links_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_pos_product_links` | `cheffing_pos_product_links_write` | ALL | public | `cheffing_is_admin()` | `cheffing_is_admin()` |
| `cheffing_pos_sales_daily` | `cheffing_pos_sales_daily_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_pos_sales_daily` | `cheffing_pos_sales_daily_write` | ALL | public | `cheffing_is_admin()` | `cheffing_is_admin()` |
| `cheffing_subrecipe_items` | `cheffing_subrecipe_items_delete` | DELETE | public | `cheffing_is_allowed()` | `` |
| `cheffing_subrecipe_items` | `cheffing_subrecipe_items_insert` | INSERT | public | `` | `cheffing_is_allowed()` |
| `cheffing_subrecipe_items` | `cheffing_subrecipe_items_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_subrecipe_items` | `cheffing_subrecipe_items_update` | UPDATE | public | `cheffing_is_allowed()` | `cheffing_is_allowed()` |
| `cheffing_subrecipes` | `cheffing_subrecipes_delete` | DELETE | public | `cheffing_is_allowed()` | `` |
| `cheffing_subrecipes` | `cheffing_subrecipes_insert` | INSERT | public | `` | `cheffing_is_allowed()` |
| `cheffing_subrecipes` | `cheffing_subrecipes_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_subrecipes` | `cheffing_subrecipes_update` | UPDATE | public | `cheffing_is_allowed()` | `cheffing_is_allowed()` |
| `cheffing_units` | `cheffing_units_delete` | DELETE | public | `cheffing_is_admin()` | `` |
| `cheffing_units` | `cheffing_units_insert` | INSERT | public | `` | `cheffing_is_admin()` |
| `cheffing_units` | `cheffing_units_select` | SELECT | public | `cheffing_is_allowed()` | `` |
| `cheffing_units` | `cheffing_units_update` | UPDATE | public | `cheffing_is_admin()` | `cheffing_is_admin()` |

## Triggers
| Tabla | Trigger | Timing | Eventos |
| --- | --- | --- | --- |
| `app_allowed_users` | `normalize_allowed_user_email` | BEFORE | INSERT, UPDATE |
| `app_allowed_users` | `trg_app_allowed_users_email_lowercase` | BEFORE | INSERT, UPDATE |
| `cheffing_dish_items` | `set_updated_at_cheffing_dish_items` | BEFORE | UPDATE |
| `cheffing_dish_items` | `trg_cheffing_dish_items_updated_at` | BEFORE | UPDATE |
| `cheffing_dishes` | `set_updated_at_cheffing_dishes` | BEFORE | UPDATE |
| `cheffing_dishes` | `trg_cheffing_dishes_updated_at` | BEFORE | UPDATE |
| `cheffing_ingredients` | `set_updated_at_cheffing_ingredients` | BEFORE | UPDATE |
| `cheffing_ingredients` | `trg_cheffing_ingredients_updated_at` | BEFORE | UPDATE |
| `cheffing_pos_product_links` | `set_updated_at_cheffing_pos_product_links` | BEFORE | UPDATE |
| `cheffing_pos_sales_daily` | `set_updated_at_cheffing_pos_sales_daily` | BEFORE | UPDATE |
| `cheffing_pos_sales_daily` | `trg_cheffing_pos_sales_daily_updated_at` | BEFORE | UPDATE |
| `cheffing_subrecipe_items` | `set_updated_at_cheffing_subrecipe_items` | BEFORE | UPDATE |
| `cheffing_subrecipe_items` | `trg_cheffing_subrecipe_items_updated_at` | BEFORE | UPDATE |
| `cheffing_subrecipes` | `set_updated_at_cheffing_subrecipes` | BEFORE | UPDATE |
| `cheffing_subrecipes` | `trg_cheffing_subrecipes_updated_at` | BEFORE | UPDATE |
| `cheffing_units` | `set_updated_at_cheffing_units` | BEFORE | UPDATE |
| `cheffing_units` | `trg_cheffing_units_updated_at` | BEFORE | UPDATE |
| `day_status` | `trg_day_status_sync_legacy_columns` | BEFORE | INSERT, UPDATE |
| `group_events` | `set_timestamp_group_events` | BEFORE | UPDATE |
| `group_events` | `trg_group_events_recalculate_staffing` | AFTER | INSERT, UPDATE |
| `group_room_allocations` | `set_timestamp_group_room_allocations` | BEFORE | UPDATE |
| `group_room_allocations` | `trg_set_override_capacity` | BEFORE | INSERT, UPDATE |
| `group_staffing_plans` | `set_timestamp_group_staffing_plans` | BEFORE | UPDATE |
| `menu_second_courses` | `set_updated_at_menu_second_courses` | BEFORE | UPDATE |
| `menus` | `set_updated_at_menus` | BEFORE | UPDATE |
| `rooms` | `set_timestamp_rooms` | BEFORE | UPDATE |
| `routines` | `set_timestamp_routines` | BEFORE | UPDATE |
| `tasks` | `set_timestamp_tasks` | BEFORE | UPDATE |

## Functions
| Función | Args | Devuelve |
| --- | --- | --- |
| `app_allowed_users_email_lowercase` | `` | `trigger` |
| `cheffing_is_admin` | `` | `boolean` |
| `cheffing_is_allowed` | `` | `boolean` |
| `day_status_sync_legacy_columns` | `` | `trigger` |
| `delete_routine_pack` | `p_pack_id uuid, p_mode text DEFAULT 'keep_all'::text, p_cutoff_week_start date DEFAULT NULL::date` | `TABLE(deleted_pack boolean, deleted_routines integer, deleted_tasks integer, unlinked_tasks integer)` |
| `delete_routine_template` | `p_routine_id uuid, p_mode text DEFAULT 'keep_all'::text, p_cutoff_week_start date DEFAULT NULL::date` | `TABLE(deleted boolean, deleted_tasks integer, unlinked_tasks integer)` |
| `generate_weekly_tasks` | `p_week_start date, p_created_by_email text DEFAULT NULL::text` | `TABLE(created integer, skipped integer)` |
| `generate_weekly_tasks_auto` | `p_week_start date, p_created_by_email text DEFAULT 'system'::text` | `TABLE(created integer, skipped integer)` |
| `generate_weekly_tasks_for_pack` | `p_week_start date, p_pack_id uuid, p_created_by_email text DEFAULT NULL::text` | `TABLE(created integer, skipped integer)` |
| `mark_past_events_completed` | `` | `void` |
| `recalculate_group_staffing_plan` | `p_group_event_id uuid` | `void` |
| `set_override_capacity` | `` | `trigger` |
| `set_updated_at` | `` | `trigger` |
| `tg_normalize_allowed_user_email` | `` | `trigger` |
| `tg_set_updated_at` | `` | `trigger` |
| `trg_recalculate_group_staffing_plan` | `` | `trigger` |

## Cómo actualizar
El snapshot de esquema vive en `supabase/schema_snapshot.sql` y se genera con `pg_dump --schema-only`.
Incluye tablas, vistas, funciones/RPC, políticas RLS (con `ALTER TABLE ... ENABLE ROW LEVEL SECURITY`), índices y constraints.
No incluye datos.
- Local/Codex: `SUPABASE_DB_URL=... bash scripts/db_snapshot.sh`
- GitHub Actions: workflow `db-schema-snapshot` (workflow_dispatch). Usa el secret `SUPABASE_DB_URL`.
